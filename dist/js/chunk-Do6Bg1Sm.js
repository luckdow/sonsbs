import{m as a,n as t,s as e,u as r,J as n,B as s}from"./chunk-CfVQzchV.js";import{d as o}from"./index-7qfwLuD9.js";const i=async(e,n)=>{try{const s=n.assignedDriver||n.assignedDriverId||n.driverId,{totalPrice:i,paymentMethod:d,customerInfo:m,tripDetails:p,manualDriverInfo:u}=n;if("manual"===s&&u)return await c(e,n);if(!s||!i)return;const y=await a(t(o,"users",s));if(!y.exists())throw new Error(`Şoför bulunamadı: ${s}`);const v=y.data(),f=i*(v.commission||15)/100,w=i-f,h=v.balance||0;let b=0,D="";"cash"===d?(b=-f,D=`Nakit rezervasyon komisyon borcu - ${e}`):"card"!==d&&"credit_card"!==d&&"bank_transfer"!==d||(b=+w,D=`Kart/Havale rezervasyon kazancı - ${e}`);const T=h+b,g={id:Date.now().toString(),type:b>0?"earning":"commission_debt",amount:Math.abs(b),note:D,date:new Date,balanceBefore:h,balanceAfter:T,reservationId:e,paymentMethod:d,totalPrice:i,commission:f,driverEarning:w,customerName:`${m?.firstName||""} ${m?.lastName||""}`,tripRoute:`${p?.pickupLocation||"Bilinmiyor"} → ${p?.dropoffLocation||"Bilinmiyor"}`},C=[...v.transactions||[],g];return await r(t(o,"users",s),{balance:T,transactions:C,lastTransactionDate:new Date,totalEarnings:(v.totalEarnings||0)+(b>0?b:0),totalCommission:(v.totalCommission||0)+f,completedTrips:(v.completedTrips||0)+1,totalCashTrips:"cash"===d?(v.totalCashTrips||0)+1:v.totalCashTrips||0,totalCardTrips:"card"===d||"bank_transfer"===d?(v.totalCardTrips||0)+1:v.totalCardTrips||0,totalCashCommission:"cash"===d?(v.totalCashCommission||0)+f:v.totalCashCommission||0,totalCardEarnings:"card"===d||"bank_transfer"===d?(v.totalCardEarnings||0)+w:v.totalCardEarnings||0}),await l(e,n,{success:!0,oldBalance:h,newBalance:T,transaction:g,driverType:"regular"}),{success:!0,oldBalance:h,newBalance:T,transaction:g,driverType:"regular"}}catch(s){throw s}},c=async(r,n)=>{try{const{totalPrice:i,paymentMethod:c,customerInfo:d,tripDetails:m,manualDriverInfo:p}=n;if(!p||!p.price)return;const u=parseFloat(p.price),y=i-u,v=p.name,f=p.phone,w=p.plateNumber,h=`manual_${f.replace(/[^0-9]/g,"")}`;let b,D=0,T="";"cash"===c?(D=-y,T=`Nakit rezervasyon - Firma payı borcu - ${r}`):"card"!==c&&"credit_card"!==c&&"bank_transfer"!==c||(D=+u,T=`Kart/Havale rezervasyon - Hak ediş alacağı - ${r}`);try{b=await a(t(o,"manual_drivers",h))}catch(s){}let g=0,C=[],B=0,$=0;if(b&&b.exists()){const a=b.data();g=a.balance||0,C=a.transactions||[],B=a.totalEarnings||0,$=a.completedTrips||0}const _=g+D,N={id:Date.now().toString(),type:D>0?"earning":"debt",amount:Math.abs(D),note:T,date:new Date,balanceBefore:g,balanceAfter:_,reservationId:r,paymentMethod:c,totalPrice:i,driverEarning:u,companyRevenue:y,customerName:`${d?.firstName||""} ${d?.lastName||""}`,tripRoute:`${m?.pickupLocation||"Bilinmiyor"} → ${m?.dropoffLocation||"Bilinmiyor"}`},E={name:v,phone:f,plateNumber:w,balance:_,transactions:[...C,N],lastTransactionDate:new Date,totalEarnings:B+(D>0?u:0),completedTrips:$+1,totalCashTrips:"cash"===c?b&&b.exists()?(b.data().totalCashTrips||0)+1:1:b&&b.exists()&&b.data().totalCashTrips||0,totalCardTrips:"card"===c||"bank_transfer"===c?b&&b.exists()?(b.data().totalCardTrips||0)+1:1:b&&b.exists()&&b.data().totalCardTrips||0,totalCashDebt:"cash"===c?b&&b.exists()?(b.data().totalCashDebt||0)+Math.abs(D):Math.abs(D):b&&b.exists()&&b.data().totalCashDebt||0,totalCardEarnings:"card"===c||"bank_transfer"===c?b&&b.exists()?(b.data().totalCardEarnings||0)+u:u:b&&b.exists()&&b.data().totalCardEarnings||0,createdAt:b&&b.exists()?void 0:new Date,updatedAt:new Date,type:"manual_driver"};return Object.keys(E).forEach(a=>{void 0===E[a]&&delete E[a]}),await e(t(o,"manual_drivers",h),E,{merge:!0}),await l(r,n,{success:!0,oldBalance:g,newBalance:_,transaction:N,driverType:"manual",driverName:v}),{success:!0,oldBalance:g,newBalance:_,transaction:N,driverType:"manual",driverName:v}}catch(s){throw s}},l=async(a,t,e)=>{try{const{totalPrice:r,paymentMethod:i,customerInfo:c,tripDetails:l,manualDriverInfo:d}=t,m="manual"===e.driverType;let p=0,u=0;if(m){const a=parseFloat(d.price);p=r-a,"card"!==i&&"bank_transfer"!==i||(u=a)}else{p=e.transaction.commission,"card"!==i&&"credit_card"!==i&&"bank_transfer"!==i||(u=e.transaction.driverEarning)}const y={id:`company_${a}_${Date.now()}`,reservationId:a,type:"reservation_completion",date:new Date,totalRevenue:r,companyRevenue:p,companyExpense:u,paymentMethod:i,driverType:e.driverType,driverName:e.driverName||"Bilinmiyor",netProfit:p-u,customerName:`${c?.firstName||""} ${c?.lastName||""}`,tripRoute:`${l?.pickupLocation||"Bilinmiyor"} → ${l?.dropoffLocation||"Bilinmiyor"}`,createdAt:new Date,processedBy:"system_auto"};await n(s(o,"company_financials"),y);const v=t.reservationNumber||t.reservationId||a,f={type:"credit",amount:r,description:`Rezervasyon Geliri - ${v}`,category:"Rezervasyon Geliri",source:"reservation_completion",reservationId:a,reservationNumber:v,paymentMethod:i,driverType:e.driverType,customerName:`${c?.firstName||""} ${c?.lastName||""}`,tripRoute:`${l?.pickupLocation||"Bilinmiyor"} → ${l?.dropoffLocation||"Bilinmiyor"}`,createdAt:new Date,createdBy:"system_auto",date:(new Date).toISOString().split("T")[0]};return await n(s(o,"financial_transactions"),f),{success:!0,companyRecord:y,incomeTransaction:f,expenseTransaction:null}}catch(r){throw r}},d=async(e,n)=>{try{const s=await a(t(o,"reservations",e));if(!s.exists())throw new Error("Rezervasyon bulunamadı");const c=s.data();if("completed"===c.status)throw new Error("Bu rezervasyon zaten tamamlanmış");if(!(c.assignedDriver||c.assignedDriverId||c.driverId))throw new Error("Bu rezervasyona şoför atanmamış");const l={status:"completed",completedAt:new Date,qrScannedAt:new Date,financialProcessed:!0};n&&null!=n&&(l.qrScannedBy=n),await r(t(o,"reservations",e),l);return{success:!0,message:"Rezervasyon başarıyla tamamlandı",reservation:c,financial:await i(e,c)}}catch(s){throw s}},m=async(e,n)=>{try{const s=await a(t(o,"reservations",e));if(!s.exists())throw new Error("Rezervasyon bulunamadı");const c=s.data();if("completed"===c.status)throw new Error("Bu rezervasyon zaten tamamlanmış");const l=await i(e,c);return await r(t(o,"reservations",e),{status:"completed",completedAt:new Date,completedBy:n,completionMethod:"manual",financialProcessed:!0}),{success:!0,message:"Rezervasyon manuel olarak tamamlandı",reservation:c,financial:l}}catch(s){throw s}};export{i as a,m,d as p,c as u};
